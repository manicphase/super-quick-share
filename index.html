<head>
  <script src="https://cdn.jsdelivr.net/webtorrent/latest/webtorrent.min.js"></script>
  <script src="js/QRScanJS/qrscan.js"></script>
  <style>
  .thumb {
    display:none;
    width: 100%;
  }
  .header {
    background-color: grey;
  }
  #footer {
    background-color: grey;
    min-height: 150px;
    border: 1px solid blue;
    max-width: 50%;
  }
  #qrcode {
    display: inline;
    float: left;
    width: 260px;
  }
  #options {
    display: none;
  }
  #options-details {
    display: inherit;
    float: left;
    max-width: 700;
  }
  #message {
    left:inherit;
    min-height: 30px;
  }
  #qrcode-dialog {
    max-width: 50%;
    min-height: 150;
    display: none;
  }
  #camera {
    display: none;
  }

  </style>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Super Quick Share</title>
</head>
<body>
<div id="header" class="header">
  <div id="options">
    <div id="qrcode"></div>
    <div id="options-details">
      Scan the QR code, copy the url in the address bar, or click the share button in your browser to share your files.<br><br>
      Warning: closing or refreshing this page will stop seeding the images you've shared, please wait until whoever you have sent them to has finished downloading them.<br><br>
      For a more persistant gallery, I'd recommend installing a webtorrent compatible desktop client such as <a href="https://webtorrent.io/desktop">Webtorrent Desktop</a>
      or <a href="http://www.vuze.com">Vuze</a> and downloading the files from this <a id="magnet_link">magnet link</a> until 100% before closing this window.<br>
      <a id="magnet_link">
    </div>
  </div>
  <div id="message">Click here for sharing options</div>
</div>
<video id="camera" width=300px autoplay></video>
<div id="qrcode-dialog">Click to use QR code reader</div>
<div id="list"></div>
<input id="filesbutton" type="file" multiple="multiple" style="display: none" />
<div id="footer" class="footer">Click or drop images here to share</div>

<script>
  show_options = false

  base_url = window.location.href
  anchor = base_url.indexOf("#")
  if (anchor > -1) {
    base_url = base_url.slice(0, anchor)
  }
  base_url = base_url.replace("127.0.0.1", "192.168.0.3")
  welcome = document.getElementById("footer")
  filesbutton = document.getElementById("filesbutton")
  filesbutton.onchange = function(event) {
    console.log("filesbutton called")
    handleFileSelect(filesbutton.files)
  }
  opendialog = function() {
    filesbutton.click()
  }
  welcome.addEventListener("click", opendialog)

  message = document.getElementById("message")
  message.addEventListener("click", shareTorrent)

  header = document.getElementById("header")

  camera = document.getElementById("camera")

  qrdialog = document.getElementById("qrcode-dialog")
  qrdialog.addEventListener("click", scanQR)


  var client = new WebTorrent()
  var imageFiles = []

  var test_ctx;
  var test_canvas;
  var infohash;

  var thumbnails = []

  function scanQR() {
    camera.style.display = "block"
    qrdialog.style.display = "none"
    QRReader.init("#camera", "js/QRScanJS/");
    QRReader.scan(function (result) {
        window.location = result
    });


  function addQrCode(url) {
    //new QRCode(document.getElementById("qrcode"), url);
    googleQR = "https://chart.googleapis.com/chart?chs=250x250&cht=qr&chl=" + encodeURIComponent(url)
    console.log(googleQR)
    document.getElementById("qrcode").innerHTML = "<img src='" + googleQR + "'></img>"
    if (show_options == false) {
      document.getElementById("qrcode").style.width = "260px"
    }
  }

  var file_drop = document.body //.getElementById('file-drop');
  file_drop.addEventListener(
    'dragover',
    function handleDragOver(evt) {
      evt.stopPropagation()
      evt.preventDefault()
      evt.dataTransfer.dropEffect = 'copy'
    },
    false
  )
  file_drop.addEventListener(
    'drop',
    function(evt) {
      evt.stopPropagation()
      evt.preventDefault()
      var files = evt.dataTransfer.files  // FileList object.
      handleFileSelect(files)
    },
    false
  )

  function handleBlob(filename) {
    return function(blob) {
      console.log("doing blob stuff")
      file = new File([blob], filename)
      imageFiles.push(file)
    }
  }

  function addMagnet(infohash) {
    magnet_link = "magnet:?xt=urn:btih:" + infohash + "&dn=photos&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.webtorrent.io&tr=wss%3A%2F%2Ftracker.openwebtorrent.com"
    document.getElementById("magnet_link").innerHTML = "<a href='" + magnet_link + "'>magnet link</a>"
  }

  console.log("ready")

  var test_event;

  function shareTorrent() {
    if (show_options) {
      document.getElementById("options").style.display = "none"
      message.innerHTML = "Click here for sharing options"
      show_options = false
    }
    else {
      message.innerHTML = "Click here to hide options"
      document.getElementById("options").style.display = "inline-block"
      show_options = true
      if (infohash) {
        addMagnet(infohash)
      }
      client.seed(imageFiles, function(torrent) {
        console.log('Client is seeding:', torrent.infoHash)
        addQrCode(base_url+"/#"+torrent.infoHash)
        addMagnet(torrent.infoHash)
        window.history.pushState({}, "sharing torrent", "#"+torrent.infoHash)
      })
    }
  }

  //client.on("ready", function(torrent) {console.log("client ready" + torrent.infoHash)})

  function downloadTorrent(torrentId) {
    console.log("dl torrent called: " + torrentId)
    client.add(torrentId,
                {announce: ['wss://tracker.webtorrent.io/',"wss://tracker.btorrent.xyz/","wss://tracker.openwebtorrent.com"]},
                function (torrent) {
      //torrent.on(ready, function() {console.log("torrent ready")})
      console.log("added torrent")
      console.log(torrent.files)

      // https://github.com/webtorrent/webtorrent/issues/164
      // Remove default selection (whole torrent)
      torrent.deselect(0, torrent.pieces.length - 1, false)

      for (f in torrent.files) {
        f = torrent.files[f]
        list = document.getElementById("list")
        if (f.name.startsWith("_thumb_")) {
          //f.addEventListener("click", save_image)
          f.appendTo(list)
          element_f = list.childNodes[list.childElementCount -1]
          element_f.setAttribute("id", f.name)
          element_f.addEventListener("click", save_image)
        }
        message.innerHTML = "Click here for sharing options"
      }
    })
  }

  this_location = window.location.href

  if (this_location.indexOf("#") > 0) {
    message.innerHTML = "Downloading torrent and previews"
    torrentId = this_location.split("#")[1]
    console.log("torrent hash found")
    downloadTorrent(torrentId)
    addQrCode(base_url+"/#"+torrentId)
    infohash = torrentId
  }
  else
  {
    qrdialog.style.display = "block"
  }

  function save_image(event) {
    test_event = event
    target_id = event.target.id.slice(7)
    //alert("clicked " + target_id)
    if (client.torrents.length > 0) {
      for (var i = 0, f; f = client.torrents[0].files[i]; i++) {
        console.log(f.name, target_id)
        if (f.name == target_id) {
          serveFile(f)
        }
      }
    }
  }

  function serveFile(f) {
    //alert("serving file")
    f.getBlobURL(function (err, url) {
      if (err) throw err
      var a = document.createElement('a')
      a.download = f.name
      a.href = url
      a.textContent = 'Download ' + f.name
      a.style = "display: none"
      document.body.appendChild(a)
      a.click()
    })
  }

  function handleFileSelect(files) {
    qrdialog.style.display = "none"
    //var files = evt.target.files; // FileList object

    // Loop through the FileList and render image files as thumbnails.
    for (var i = 0, f; f = files[i]; i++) {
      // Only process image files.
      console.log("processing file")
      if (!f.type.match('image.*')) {
        continue;
      }

      imageFiles.push(f)

      console.log("doing image stuff")
      var img = document.createElement("img");


      doImageStuff = function(f) {
        return function(event) {
          thumb_width = 330
          console.log("blah", event)
          test_event = event
          var canvas = document.createElement("canvas");
          var ctx = canvas.getContext("2d");
          console.log(canvas.height)
          var new_height = img.height * (thumb_width/img.width)
          ctx.canvas.height = new_height
          i = new Image(thumb_width, new_height)
          ctx.drawImage(event.target, 0,0, thumb_width,new_height)
          canvas.setAttribute("id", "_thumb_" + f.name)
          canvas.addEventListener("click", save_image)
          document.getElementById("list").appendChild(canvas)
          canvas.toBlob(handleBlob("_thumb_" + f.name),"image/jpeg", 0.8)
        }
      }

      img.addEventListener("load", doImageStuff(f))

      console.log(URL.createObjectURL(f))
      img.src = URL.createObjectURL(f)

    }
  }

</script>
</body>
